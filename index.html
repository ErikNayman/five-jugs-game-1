<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –ì–æ–Ω–∫–∞: Remastered</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; overflow-x: hidden; touch-action: manipulation; }

        /* --- TICKER --- */
        .ticker-wrap {
            position: fixed; top: 0; left: 0; width: 100%; overflow: hidden; height: 24px; background-color: #0f172a; 
            padding-left: 100%; box-sizing: content-box; z-index: 100;
        }
        .ticker {
            display: inline-block; height: 24px; line-height: 24px; white-space: nowrap;
            padding-right: 100%; box-sizing: content-box;
            animation: ticker 40s linear infinite;
        }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        .ticker-item { display: inline-block; padding: 0 2rem; font-size: 10px; color: #cbd5e1; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        
        body { padding-top: 24px; }

        /* --- VISUAL ROOM (COMPACT) --- */
        .visual-room {
            height: 100px;
            background: linear-gradient(180deg, #A7F3D0 0%, #F1F5F9 100%);
            position: relative; overflow: hidden; transition: all 0.5s ease;
            border-bottom: 4px solid #CBD5E1;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        /* Floor removed as requested */
        .room-object {
            position: absolute; bottom: 15px; font-size: 40px; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 3px 4px rgba(0,0,0,0.1));
        }

        /* --- JARS & THRESHOLDS --- */
        .jar-container {
            position: relative; height: 180px; background-color: #E2E8F0; 
            border-radius: 0 0 12px 12px; overflow: hidden;
            border: 2px solid #CBD5E1; border-top: none; cursor: ns-resize; touch-action: none; 
            transition: box-shadow 0.3s;
        }
        .jar-liquid {
            position: absolute; bottom: 0; left: 0; right: 0;
            transition: height 0.1s linear; pointer-events: none; z-index: 10;
        }
        .jar-drag-handle {
            position: absolute; top: 0; left: 50%; transform: translate(-50%, -50%);
            width: 30px; height: 20px; background: white; border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: #94A3B8; display: flex; 
            align-items: center; justify-content: center; font-size: 10px; z-index: 20;
        }
        
        /* Threshold Line Styles */
        .threshold-line {
            position: absolute; left: 0; right: 0; 
            border-top: 2px dashed rgba(0,0,0,0.3);
            z-index: 15; pointer-events: none;
        }
        .threshold-label {
            position: absolute; right: 2px; bottom: 2px;
            font-size: 8px; font-weight: 800; color: rgba(0,0,0,0.4);
            text-transform: uppercase; background: rgba(255,255,255,0.5);
            padding: 0 2px; border-radius: 2px;
        }
        
        .crit-pulse {
            animation: pulse-red 1s infinite;
            border-color: #F43F5E !important;
            box-shadow: 0 0 15px rgba(244, 63, 94, 0.3);
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(244, 63, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0); }
        }

        /* Shop Bounce Animation */
        .shop-bounce { animation: shop-bounce 2s infinite; }
        @keyframes shop-bounce { 
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 
            40% { transform: translateY(-5px); } 
            60% { transform: translateY(-3px); } 
        }
        
        /* --- UI ELEMENTS --- */
        .rival-marker { 
            position: absolute; top: -2px; bottom: -2px; width: 4px; background: #F43F5E; 
            box-shadow: 0 0 8px #F43F5E; transition: left 0.5s ease; z-index: 20; border-radius: 2px;
        }
        .tooltip {
            visibility: hidden; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 6px 10px; border-radius: 6px; font-size: 11px;
            white-space: nowrap; opacity: 0; transition: opacity 0.2s; z-index: 50; pointer-events: none;
            margin-bottom: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent;
        }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }

        .xp-stripe {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem; animation: progress-stripes 1s linear infinite;
        }
        @keyframes progress-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }
        
        .btn-push { transition: transform 0.1s, background-color 0.2s; }
        .btn-push:active { transform: scale(0.95); }

        /* --- TOAST --- */
        .toast-container {
            position: fixed; top: 90px; left: 50%; transform: translateX(-50%);
            z-index: 120; pointer-events: none; width: 90%; max-width: 400px;
        }
        .toast {
            background: rgba(30, 41, 59, 0.95); color: white; padding: 12px 16px; 
            border-radius: 50px; margin-bottom: 10px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex; align-items: center; gap: 12px; font-size: 12px;
            opacity: 0; transform: translateY(-20px); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; items-center; justify-content: center; flex-shrink: 0; }
        .toast-warning .toast-icon { background: #F43F5E; }
        .toast-success .toast-icon { background: #10B981; }

        /* STRATEGY & SHOP CARDS */
        .card-select { border: 2px solid transparent; transition: all 0.2s; cursor: pointer; }
        .card-select:hover { transform: translateY(-2px); border-color: #cbd5e1; }
        .card-select.active { border-color: #10B981; background-color: #F0FDF4; }
        
        /* SHOP ITEM */
        .shop-item { transition: all 0.2s; }
        .shop-item:active { transform: scale(0.98); }
        .shop-item.disabled { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 pb-20 md:pb-0">

    <!-- TICKER -->
    <div class="ticker-wrap">
        <div class="ticker" id="newsTicker">
            <div class="ticker-item">–†–∏–Ω–æ–∫: <span class="text-emerald-400">–ë–∏—á–∞—á–∏–π —Ç—Ä–µ–Ω–¥ (+8%)</span></div>
            <div class="ticker-item">–ù–æ–≤–∏–Ω–∏: –Ü–Ω—Ñ–ª—è—Ü—ñ—è —Å–ø–æ–≤—ñ–ª—å–Ω—é—î—Ç—å—Å—è</div>
            <div class="ticker-item">–ü–æ—Ä–∞–¥–∞: –¢—Ä–∏–º–∞–π—Ç–µ >10% —É –°–µ–π—Ñ—ñ</div>
            <div class="ticker-item">–†–∏–Ω–æ–∫: <span class="text-rose-400">–ö—Ä–∏–ø—Ç–∞ –ø–∞–¥–∞—î (-5%)</span></div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 sticky top-6 z-40 shadow-sm backdrop-blur-md bg-white/90">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            
            <!-- Left: Menu & Stats -->
            <div class="flex items-center gap-3">
                <button onclick="openMenu()" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-gear"></i>
                </button>
                <div class="flex flex-col">
                    <div class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">–í–∞—à –ö–∞–ø—ñ—Ç–∞–ª</div>
                    <div class="flex items-baseline gap-2">
                        <div id="netWorthDisplay" class="text-2xl font-black text-slate-800 leading-none">$0</div>
                        <div class="text-[10px] font-bold text-rose-500 bg-rose-50 px-1.5 rounded border border-rose-100">
                            VS <span id="rivalNetWorthDisplay">$0</span> —É –î–∂–æ
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Shop & Action -->
            <div class="flex gap-2">
                <button id="shopBtn" onclick="openShop()" class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 border border-indigo-100 hover:bg-indigo-100 flex items-center justify-center transition-all shadow-sm relative">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <div id="shopBadge" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-rose-500 rounded-full border-2 border-white"></div>
                </button>
                <button id="nextMonthBtn" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-2 px-5 rounded-xl shadow-lg shadow-slate-900/20 btn-push flex items-center gap-2">
                    <span class="hidden sm:inline">–ù–∞—Å—Ç. –ú—ñ—Å—è—Ü—å</span>
                    <span class="sm:hidden">–î–∞–ª—ñ</span>
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-4xl mx-auto w-full px-4 py-4 space-y-4">

        <!-- 1. FREEDOM & CHART -->
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
            <div class="mb-4">
                <div class="flex justify-between items-end mb-1">
                    <div class="flex flex-col">
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">–ú–µ—Ç–∞: –°–≤–æ–±–æ–¥–∞ (F.I.R.E.)</span>
                        <span class="text-xs font-bold text-slate-700">–ù–∞–∫–æ–ø–∏—á–µ–Ω–æ: <span id="freedomCurrentPct">0%</span></span>
                    </div>
                    <div class="text-right">
                         <span id="freedomYearsText" class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded">‚àû —Ä–æ–∫—ñ–≤</span>
                    </div>
                </div>
                <div class="relative h-4 w-full bg-slate-100 rounded-full overflow-hidden border border-slate-100">
                    <div id="freedomBar" class="h-full bg-gradient-to-r from-emerald-400 to-teal-500 transition-all duration-700" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-[9px] text-slate-400 mt-1 font-bold">
                    <span>–°—Ç–∞—Ä—Ç</span>
                    <span>–¶—ñ–ª—å: <span id="freedomGoalVal">$720k</span></span>
                </div>
            </div>

            <div class="h-48 w-full relative border-t border-slate-100 pt-2">
                <canvas id="mainChart"></canvas>
            </div>
            
            <!-- Custom Legend & Joe's Bubble -->
            <div class="flex justify-between items-center mt-2 px-1">
                <!-- Custom Legend -->
                <div class="flex gap-2 text-[9px] sm:text-[10px]">
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded bg-emerald-500 opacity-60"></div><span class="text-slate-500 font-bold">–°–µ–π—Ñ</span></div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded bg-indigo-500 opacity-60"></div><span class="text-slate-500 font-bold">–†–∏–∑–∏–∫</span></div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full border border-rose-500 border-dashed"></div><span class="text-slate-500 font-bold">–î–∂–æ</span></div>
                </div>
                
                <!-- Bubble (Wider, no truncate) -->
                <div id="rivalBubble" class="text-[9px] sm:text-[10px] bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-200 text-slate-500 italic text-right max-w-[240px]">
                    <span class="font-bold not-italic text-rose-500">–î–∂–æ:</span> "..."
                </div>
            </div>
        </div>

        <!-- 2. VISUAL ROOM & VITALS -->
        <div class="relative">
            <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1"><i class="fa-solid fa-layer-group mr-1"></i> –†—ñ–≤–µ–Ω—å –ñ–∏—Ç—Ç—è</h2>
            <div class="visual-room" id="visualRoom">
                <div id="roomObjects"></div>
                <div id="roomLabel" class="absolute top-2 right-2 bg-emerald-500 text-white px-3 py-1 rounded-full text-[10px] font-bold shadow-sm uppercase tracking-wider transition-all">
                    –í–∏–∂–∏–≤–∞–Ω–Ω—è
                </div>
            </div>
            
            <div class="absolute bottom-1 left-3 right-3 flex justify-between gap-2">
                <div class="bg-white/95 backdrop-blur rounded-lg p-1.5 shadow border border-slate-200 flex items-center gap-2 has-tooltip cursor-help flex-1" id="healthWidget">
                    <div class="tooltip" id="healthTooltip">–ü–æ—Ç—Ä—ñ–±–Ω–æ >50% –Ω–∞ –ñ–∏—Ç—Ç—è</div>
                    <div class="w-6 h-6 rounded bg-rose-100 text-rose-500 flex items-center justify-center text-xs"><i class="fa-solid fa-heart"></i></div>
                    <div class="flex-grow">
                        <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                            <div id="hpBar" class="h-full bg-rose-500 transition-all duration-300" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white/95 backdrop-blur rounded-lg p-1.5 shadow border border-slate-200 flex items-center gap-2 has-tooltip cursor-help flex-1" id="happyWidget">
                    <div class="tooltip" id="happyTooltip">–ü–æ—Ç—Ä—ñ–±–Ω–æ >20% –Ω–∞ –†–∞–¥—ñ—Å—Ç—å</div>
                    <div class="w-6 h-6 rounded bg-amber-100 text-amber-500 flex items-center justify-center text-xs"><i class="fa-solid fa-face-smile"></i></div>
                    <div class="flex-grow">
                        <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                            <div id="happyBar" class="h-full bg-amber-500 transition-all duration-300" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. JARS -->
        <div>
            <div class="flex justify-between items-center mb-2 px-1">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest"><i class="fa-solid fa-scale-balanced mr-1"></i> –†–æ–∑–ø–æ–¥—ñ–ª –ë—é–¥–∂–µ—Ç—É</h2>
            </div>
            <div class="grid grid-cols-5 gap-2" id="jarsContainer"></div>
            <div class="text-[10px] text-slate-400 text-center mt-2 leading-tight">
                "–°–µ–π—Ñ" <i class="fa-solid fa-shield-halved text-emerald-500 mx-0.5"></i> ‚Äî —Ü–µ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É –¥–ª—è —ñ–Ω—à–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π.
            </div>
        </div>

        <!-- 4. DETAILS -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                <div class="text-[9px] font-bold text-slate-400 uppercase mb-1">–ó–∞—Ä–ø–ª–∞—Ç–∞</div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-lg font-black text-slate-800" id="incomeDisplay">$4,000</span>
                    <span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-1.5 rounded" id="incomeBoostDisplay">+0%</span>
                </div>
                <div class="text-[9px] font-bold text-slate-400 uppercase flex justify-between mb-0.5">
                    <span>–ö–∞—Ä'—î—Ä–∞ (XP)</span>
                    <span id="xpText">0/100</span>
                </div>
                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div id="xpBar" class="h-full bg-blue-500 xp-stripe transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">–ü–∞—Å–∏–≤–Ω–∏–π –¥–æ—Ö—ñ–¥</div>
                        <div class="text-[9px] font-bold text-indigo-500" id="passiveIncomeVal">+$0</div>
                    </div>
                    <!-- STRATEGY SELECTOR -->
                    <button onclick="openStrategyModal()" id="strategyBtn" class="w-full text-left text-[10px] bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded px-2 py-1 flex justify-between items-center transition-colors">
                        <span><i class="fa-solid fa-chart-line mr-1"></i> <span id="strategyName">–ê–∫—Ü—ñ—ó</span></span>
                        <i class="fa-solid fa-chevron-down text-slate-300"></i>
                    </button>
                </div>
                <div class="h-px bg-slate-100 my-1.5"></div>
                <div class="flex justify-between items-center">
                    <div class="text-[9px] font-bold text-slate-400 uppercase">–ü–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞ –º—ñ—Å—è—Ü—å</div>
                    <div class="text-sm font-bold text-slate-700" id="monthlyExpensesVal">$2,400</div>
                </div>
            </div>
        </div>
    </main>

    <!-- SHOP MODAL -->
    <div id="shopModal" class="fixed inset-0 z-[100] bg-slate-900/90 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-all duration-300 flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-slate-100 bg-indigo-50 flex justify-between items-center">
                <h2 class="font-bold text-indigo-900 flex items-center gap-2"><i class="fa-solid fa-store"></i> –ú–∞–≥–∞–∑–∏–Ω</h2>
                <button onclick="closeShop()" class="text-indigo-300 hover:text-indigo-500"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="p-3 bg-indigo-100/50 text-center">
                <div class="text-[10px] uppercase font-bold text-indigo-400">–î–æ—Å—Ç—É–ø–Ω–æ –≤ –°–µ–π—Ñ—ñ</div>
                <div class="text-xl font-black text-indigo-600" id="shopBalanceDisplay">$0</div>
            </div>
            <div class="p-4 space-y-3 overflow-y-auto flex-grow" id="shopItemsContainer"></div>
        </div>
    </div>

    <!-- EVENT MODAL -->
    <div id="eventModal" class="fixed inset-0 z-[100] bg-slate-900/90 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-all duration-300" id="eventCard">
            <div class="bg-indigo-600 p-4 text-white flex gap-4 items-center">
                <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                    <i id="eventIcon" class="fa-solid fa-bolt"></i>
                </div>
                <div>
                    <div class="text-[10px] font-bold opacity-75 uppercase tracking-wider">–ü–æ–¥—ñ—è</div>
                    <h2 id="eventTitle" class="text-xl font-bold leading-tight">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h2>
                </div>
            </div>
            <div class="p-6">
                <p id="eventDesc" class="text-slate-600 mb-6 text-sm leading-relaxed">–û–ø–∏—Å –ø–æ–¥—ñ—ó...</p>
                <div class="space-y-3" id="eventOptions"></div>
            </div>
        </div>
    </div>

    <!-- STRATEGY MODAL -->
    <div id="strategyModal" class="fixed inset-0 z-[100] bg-slate-900/90 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-all duration-300">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h2 class="font-bold text-slate-800">–°—Ç—Ä–∞—Ç–µ–≥—ñ—è –Ü–Ω–≤–µ—Å—Ç–∏—Ü—ñ–π</h2>
                <button onclick="closeStrategyModal()" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 space-y-3" id="strategyOptions"></div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 z-[95] bg-slate-900/90 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-6 transform scale-95 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-slate-800">–ú–µ–Ω—é</h2>
                <button onclick="closeMenu()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="space-y-3">
                <button onclick="saveGame(true)" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-xl flex items-center justify-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> –ó–±–µ—Ä–µ–≥—Ç–∏
                </button>
                <!-- Changed to use requestReset for safety without blocking confirm() -->
                <button onclick="requestReset(this)" class="w-full bg-rose-50 hover:bg-rose-100 text-rose-600 font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all">
                    <i class="fa-solid fa-rotate-left"></i> –ù–æ–≤–∞ –≥—Ä–∞
                </button>
                <div class="text-[10px] text-center text-slate-400 pt-2">
                    –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É–≤—ñ–º–∫–Ω–µ–Ω–æ
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- GAME OVER -->
    <div id="endGameModal" class="fixed inset-0 z-[100] bg-slate-900/95 hidden flex items-center justify-center p-6 opacity-0 transition-opacity duration-500">
        <div class="bg-white rounded-3xl p-6 max-w-sm w-full text-center shadow-2xl">
            <div id="endIcon" class="text-5xl mb-4">üíÄ</div>
            <h2 id="endTitle" class="text-2xl font-black mb-2 text-slate-800">GAME OVER</h2>
            <p id="endDesc" class="text-sm text-slate-600 mb-6">...</p>
            <!-- Fixed Reset Button (No Confirm) -->
            <button onclick="resetGame(true)" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:scale-105 transition-transform">–ü–æ—á–∞—Ç–∏ –ó–Ω–æ–≤—É</button>
        </div>
    </div>

    <script>
        // --- HAPTICS ---
        function triggerHaptic(pattern = 10) {
            if (navigator.vibrate) navigator.vibrate(pattern);
        }

        // --- CONFIG ---
        const JARS = [
            { id: 'nec', name: '–ñ–∏—Ç—Ç—è', icon: 'fa-house', color: '#64748B', liq: '#94A3B8', def: 60, min: 20 },
            { id: 'fun', name: '–†–∞–¥—ñ—Å—Ç—å', icon: 'fa-gamepad', color: '#F59E0B', liq: '#FCD34D', def: 10, min: 5 },
            { id: 'edu', name: '–†–æ–∑–≤–∏—Ç–æ–∫', icon: 'fa-graduation-cap', color: '#3B82F6', liq: '#60A5FA', def: 10, min: 0 },
            { id: 'sav', name: '–°–µ–π—Ñ', icon: 'fa-shield-halved', color: '#10B981', liq: '#34D399', def: 10, min: 0 },
            { id: 'inv', name: '–†–∏–∑–∏–∫', icon: 'fa-rocket', color: '#6366F1', liq: '#818CF8', def: 10, min: 0 }
        ];

        const STRATEGIES = {
            'bonds': { name: '–û–±–ª—ñ–≥–∞—Ü—ñ—ó', rate: 0.05, vol: 0.02, desc: '–ù–∞–¥—ñ–π–Ω–æ. 5% —Ä—ñ—á–Ω–∏—Ö.', icon: 'fa-scale-balanced', color: 'text-emerald-600' },
            'stocks': { name: '–ê–∫—Ü—ñ—ó', rate: 0.10, vol: 0.10, desc: '–ë–∞–ª–∞–Ω—Å. 10% —Ä—ñ—á–Ω–∏—Ö.', icon: 'fa-chart-line', color: 'text-blue-600' },
            'crypto': { name: '–ö—Ä–∏–ø—Ç–∞', rate: 0.25, vol: 0.40, desc: '–ê–∑–∞—Ä—Ç. 25% —Ä—ñ—á–Ω–∏—Ö.', icon: 'fa-bitcoin-sign', color: 'text-rose-600' }
        };

        const SHOP_ITEMS = [
            { id: 'weekend', name: '–í–∏—Ö—ñ–¥–Ω—ñ –∑–∞ –º—ñ—Å—Ç–æ–º', cost: 300, type: 'consumable', icon: 'fa-campground', desc: '+30 –©–∞—Å—Ç—è', effect: (s) => s.happiness = Math.min(100, s.happiness + 30) },
            { id: 'checkup', name: '–ú–µ–¥–æ–≥–ª—è–¥', cost: 300, type: 'consumable', icon: 'fa-user-doctor', desc: '+30 –ó–¥–æ—Ä–æ–≤\'—è', effect: (s) => s.health = Math.min(100, s.health + 30) },
            { id: 'gym', name: '–ê–±–æ–Ω–µ–º–µ–Ω—Ç —É –∑–∞–ª', cost: 800, type: 'permanent', icon: 'fa-dumbbell', desc: '–ó–¥–æ—Ä–æ–≤\'—è –ø–∞–¥–∞—î –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ', unique: true },
            { id: 'console', name: '–Ü–≥—Ä–æ–≤–∞ –∫–æ–Ω—Å–æ–ª—å', cost: 800, type: 'permanent', icon: 'fa-gamepad', desc: '–©–∞—Å—Ç—è –ø–∞–¥–∞—î –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ', unique: true },
            { id: 'course', name: '–û–Ω–ª–∞–π–Ω –ö—É—Ä—Å', cost: 1200, type: 'consumable', icon: 'fa-laptop-code', desc: '+50 XP –ö–∞—Ä\'—î—Ä–∏', effect: (s) => s.careerXP += 50 }
        ];

        const DILEMMAS = [
            { id: 'tooth', title: '–ó—É–±–Ω–∏–π –ë—ñ–ª—å', text: '–ó—É–± –º—É–¥—Ä–æ—Å—Ç–∏ –≤–∏—Ä—ñ—à–∏–≤ –≤—Å–µ –∑—ñ–ø—Å—É–≤–∞—Ç–∏. –ë—ñ–ª—å –Ω–µ—Å—Ç–µ—Ä–ø–Ω–∏–π.', icon: 'fa-tooth', options: [{ text: '–õ—ñ–∫—É–≤–∞—Ç–∏ (-$400)', cost: 400, health: 5, happy: 5 }, { text: '–¢–µ—Ä–ø—ñ—Ç–∏', cost: 0, health: -15, happy: -20 }] },
            { id: 'car', title: '–ü–æ–ª–æ–º–∫–∞ –ê–≤—Ç–æ', text: '–ú–∞—à–∏–Ω–∞ –Ω–µ –∑–∞–≤–æ–¥–∏—Ç—å—Å—è. –ü–æ—Ç—Ä—ñ–±–µ–Ω —Ä–µ–º–æ–Ω—Ç –∞–±–æ –∞–≤—Ç–æ–±—É—Å.', icon: 'fa-car-burst', options: [{ text: '–†–µ–º–æ–Ω—Ç (-$600)', cost: 600, health: 0, happy: 5 }, { text: '–ü—ñ—à–∫–∏', cost: 0, health: 5, happy: -15 }] },
            { id: 'startup', title: '–°—Ç–∞—Ä—Ç–∞–ø –î—Ä—É–≥–∞', text: '–î—Ä—É–≥ –ø—Ä–æ—Å–∏—Ç $1000 –Ω–∞ "–≥–µ–Ω—ñ–∞–ª—å–Ω—É —ñ–¥–µ—é" (–õ–∞—Ä—å–æ–∫ –∑ —à–∞—É—Ä–º–æ—é).', icon: 'fa-rocket', options: [{ text: '–Ü–Ω–≤–µ—Å—Ç—É–≤–∞—Ç–∏ (-$1000)', cost: 1000, effect: 'risky_invest' }, { text: '–í—ñ–¥–º–æ–≤–∞', cost: 0, happy: -5 }] },
            { id: 'mba', title: '–ö—É—Ä—Å–∏ MBA', text: '–ì–∞—Ä—è—á–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è! –ù–∞–≤—á–∞–Ω–Ω—è –∑–∞ $2000. –û–±—ñ—Ü—è—é—Ç—å —Ä—ñ—Å—Ç –ó–ü.', icon: 'fa-user-graduate', options: [{ text: '–ö—É–ø–∏—Ç–∏ (-$2000)', cost: 2000, xp: 80, happy: -5 }, { text: '–ù–µ–º–∞—î –≥—Ä–æ—à–µ–π', cost: 0, happy: 0 }] }
        ];

        const RIVAL_PHRASES = [ "–¢–∏—Ö—ñ—à–µ —ó–¥–µ—à ‚Äî –¥–∞–ª—ñ –±—É–¥–µ—à.", "–£ –±–∞–Ω–∫—É –Ω–∞–¥—ñ–π–Ω–æ, –∞ —Ç–∏ —Ä–∏–∑–∏–∫—É—î—à.", "–ú–æ—ó 4% –∫–∞–ø–∞—é—Ç, —è —Å–ø–æ–∫—ñ–π–Ω–∏–π.", "–°–∫–ª–∞–¥–Ω–∏–π –≤—ñ–¥—Å–æ—Ç–æ–∫ –ø—Ä–∞—Ü—é—î –Ω–∞ –º–µ–Ω–µ.", "–ñ–æ–¥–Ω–æ–≥–æ —Å—Ç—Ä–µ—Å—É, —Ç—ñ–ª—å–∫–∏ –¥–µ–ø–æ–∑–∏—Ç." ];

        let state = {
            month: 1, baseIncome: 4000, incomeMultiplier: 1.0,
            netWorth: 0, rivalNetWorth: 0, savings: 0, investments: 0,
            allocations: {}, health: 100, happiness: 100, careerXP: 0,
            activeStrategy: 'stocks', inventory: [],
            purchaseCounts: {},
            history: { labels: [], savings: [], investments: [], rival: [] }
        };

        JARS.forEach(j => state.allocations[j.id] = j.def);
        let chartInstance, isDragging = false, activeJarId = null;

        function init() {
            renderJars(); initChart(); loadGame(); updateUI();
            window.addEventListener('mouseup', endDrag); window.addEventListener('touchend', endDrag);
            window.addEventListener('mousemove', onDrag); window.addEventListener('touchmove', onDrag, { passive: false });
            document.getElementById('nextMonthBtn').addEventListener('click', nextMonth);
        }

        function saveGame(manual = false) {
            try { localStorage.setItem('finRaceSave', JSON.stringify(state)); if (manual) { showToast('–ì—Ä—É —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!', 'success'); closeMenu(); } } catch (e) {}
        }
        function loadGame() {
            try {
                const saved = localStorage.getItem('finRaceSave');
                if (saved) { 
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    if(!state.purchaseCounts) state.purchaseCounts = {};
                    if(chartInstance) updateChart(); 
                }
            } catch (e) {}
        }
        
        // Double-tap confirmation logic to avoid browser 'confirm' blocking
        let resetStage = 0;
        function requestReset(btn) {
            if (resetStage === 0) {
                resetStage = 1;
                btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?';
                btn.className = "w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all";
                // Auto-revert after 3 seconds
                setTimeout(() => {
                    if(resetStage === 1) {
                        resetStage = 0;
                        btn.innerHTML = '<i class="fa-solid fa-rotate-left"></i> –ù–æ–≤–∞ –≥—Ä–∞';
                        btn.className = "w-full bg-rose-50 hover:bg-rose-100 text-rose-600 font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all";
                    }
                }, 3000);
            } else {
                resetGame(true);
                resetStage = 0;
                btn.innerHTML = '<i class="fa-solid fa-rotate-left"></i> –ù–æ–≤–∞ –≥—Ä–∞';
                btn.className = "w-full bg-rose-50 hover:bg-rose-100 text-rose-600 font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all";
            }
        }

        // REFACTORED RESET
        function resetGame(force = false) { 
            // Force ignores confirm, useful for Game Over screen or double-tap logic
            if(force || confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å –±—É–¥–µ —Å–∫–∏–Ω—É—Ç–æ.")) { 
                localStorage.removeItem('finRaceSave'); 
                state = {
                    month: 1, baseIncome: 4000, incomeMultiplier: 1.0,
                    netWorth: 0, rivalNetWorth: 0, savings: 0, investments: 0,
                    allocations: {}, health: 100, happiness: 100, careerXP: 0,
                    activeStrategy: 'stocks', inventory: [],
                    purchaseCounts: {},
                    history: { labels: [], savings: [], investments: [], rival: [] }
                };
                JARS.forEach(j => state.allocations[j.id] = j.def);
                if(chartInstance) { chartInstance.data.labels=[]; chartInstance.data.datasets.forEach(d=>d.data=[]); chartInstance.update(); }
                
                const egm = document.getElementById('endGameModal');
                egm.classList.add('opacity-0');
                setTimeout(() => egm.classList.add('hidden'), 300);
                
                document.getElementById('settingsModal').classList.add('hidden');
                updateUI();
                showToast("–ì—Ä—É —Å–∫–∏–Ω—É—Ç–æ", "info");
                triggerHaptic([50, 50]);
            } 
        }

        // --- SHOP ---
        function openShop() {
            document.getElementById('shopBalanceDisplay').innerText = '$' + Math.floor(state.savings).toLocaleString();
            const c = document.getElementById('shopItemsContainer'); c.innerHTML = '';
            SHOP_ITEMS.forEach(item => {
                const owned = state.inventory.includes(item.id);
                // Calculate dynamic cost
                const count = state.purchaseCounts[item.id] || 0;
                const currentCost = item.type === 'consumable' ? Math.floor(item.cost * Math.pow(1.5, count)) : item.cost;
                
                const afford = state.savings >= currentCost;
                
                const el = document.createElement('div');
                el.className = `flex items-center gap-3 p-3 rounded-xl border ${owned ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-200 shop-item'}`;
                if(!afford && !owned) el.classList.add('disabled');
                
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${owned ? 'bg-emerald-500 text-white' : 'bg-indigo-100 text-indigo-500'} text-lg"><i class="fa-solid ${item.icon}"></i></div>
                    <div class="flex-grow">
                        <div class="font-bold text-sm text-slate-800">${item.name}</div>
                        <div class="text-[10px] text-slate-500">${item.desc}</div>
                    </div>
                    ${owned ? '<div class="text-xs font-bold text-emerald-600"><i class="fa-solid fa-check"></i></div>' : 
                    `<button onclick="buyItem('${item.id}')" class="px-3 py-1.5 rounded-lg text-xs font-bold bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95 transition">$${currentCost.toLocaleString()}</button>`}
                `;
                c.appendChild(el);
            });
            const m = document.getElementById('shopModal'); m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10);
        }
        function closeShop() { const m = document.getElementById('shopModal'); m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); }
        
        function buyItem(id) {
            const item = SHOP_ITEMS.find(i=>i.id===id);
            const count = state.purchaseCounts[id] || 0;
            const currentCost = item.type === 'consumable' ? Math.floor(item.cost * Math.pow(1.5, count)) : item.cost;

            if(state.savings >= currentCost) {
                state.savings -= currentCost;
                
                if(item.type === 'permanent') {
                    state.inventory.push(id);
                } else {
                    // Increment purchase count for dynamic pricing
                    state.purchaseCounts[id] = count + 1;
                }
                
                if(item.effect) item.effect(state);
                
                // Check xp overflow for course
                if(state.careerXP >= 100) { 
                    state.careerXP -= 100; 
                    state.incomeMultiplier += 0.1; 
                    showToast("–ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è!", "success"); 
                    triggerHaptic([50, 50, 50]); 
                }
                
                showToast(`–ö—É–ø–ª–µ–Ω–æ: ${item.name}`, 'success');
                updateUI(); 
                openShop(); // Re-render shop to update prices
                saveGame();
            }
        }

        // --- STRATEGY ---
        function openStrategyModal() {
            const m = document.getElementById('strategyModal'); const c = document.getElementById('strategyOptions'); c.innerHTML = '';
            Object.keys(STRATEGIES).forEach(key => {
                const s = STRATEGIES[key]; const isActive = state.activeStrategy === key;
                const el = document.createElement('div'); el.className = `card-select p-3 rounded-xl border flex items-center gap-3 ${isActive ? 'active' : 'border-slate-200 bg-white'}`;
                el.onclick = () => { state.activeStrategy = key; updateUI(); closeStrategyModal(); showToast(`–°—Ç—Ä–∞—Ç–µ–≥—ñ—è: ${s.name}`); triggerHaptic(10); };
                el.innerHTML = `<div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center ${s.color} text-lg"><i class="fa-solid ${s.icon}"></i></div><div class="flex-grow"><div class="font-bold text-sm text-slate-800">${s.name}</div><div class="text-[10px] text-slate-500">${s.desc}</div></div>${isActive ? '<i class="fa-solid fa-circle-check text-emerald-500"></i>' : ''}`;
                c.appendChild(el);
            });
            m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10);
        }
        function closeStrategyModal() { const m = document.getElementById('strategyModal'); m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); }

        function openMenu() { const m = document.getElementById('settingsModal'); m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10); }
        function closeMenu() { const m = document.getElementById('settingsModal'); m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); }

        function nextMonth() {
            triggerHaptic(20);
            processMonthLogic();
            if (Math.random() < 0.3) { const d = DILEMMAS[Math.floor(Math.random() * DILEMMAS.length)]; showDilemma(d); }
            saveGame();
        }

        function processMonthLogic() {
            const eduPct = state.allocations.edu;
            const xpGain = eduPct > 5 ? (eduPct - 5) * 1.5 : 0; 
            state.careerXP += xpGain;
            if(state.careerXP >= 100) { state.careerXP -= 100; state.incomeMultiplier += 0.10; triggerConfetti(); triggerHaptic([50, 50, 50]); showToast("–ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è! –ó–∞—Ä–ø–ª–∞—Ç–∞ +10%", "success"); }

            let healthPenalty = 1.0;
            if (state.health < 50) healthPenalty = 0.8;
            if (state.health < 20) healthPenalty = 0.5;
            const realIncome = (state.baseIncome * state.incomeMultiplier) * healthPenalty;

            JARS.forEach(j => {
                const amt = realIncome * (state.allocations[j.id] / 100);
                if (j.id === 'sav') state.savings += amt;
                if (j.id === 'inv') state.investments += amt;
            });

            state.savings += state.savings * (0.04 / 12);
            
            // --- INVESTMENT LOGIC ---
            const strat = STRATEGIES[state.activeStrategy];
            
            // 1. Calculate standard volatility
            let marketMood = (Math.random() * (strat.vol * 2)) - strat.vol;
            
            // 2. Specific Stock Market Events override (User Request)
            if (state.activeStrategy === 'stocks') {
                const eventRoll = Math.random();
                
                if (eventRoll < 0.01) { 
                    // 1% Chance: CRASH -20%
                    marketMood = -0.20;
                    showToast("üí• –û–ë–í–ê–õ –†–ò–ù–ö–£! –ê–∫—Ü—ñ—ó –≤–ø–∞–ª–∏ –Ω–∞ 20%", "warning");
                    triggerHaptic([100, 50, 100, 50, 100]);
                } else if (eventRoll < 0.05) {
                    // 4% Chance: Correction -10%
                    marketMood = -0.10;
                    showToast("üìâ –°–∏–ª—å–Ω–∞ –∫–æ—Ä–µ–∫—Ü—ñ—è! –ê–∫—Ü—ñ—ó -10%", "warning");
                    triggerHaptic([50, 50]);
                } else if (eventRoll < 0.15) {
                    // 10% Chance: Correction -5%
                    marketMood = -0.05;
                    showToast("üìâ –ö–æ—Ä–µ–∫—Ü—ñ—è —Ä–∏–Ω–∫—É (-5%)", "warning");
                    triggerHaptic([30]);
                }
            }

            // Crypto/General Alerts
            if (state.activeStrategy === 'crypto' && marketMood < -0.15) { 
                showToast("–ö—Ä–∏–ø—Ç–∞ –æ–±–≤–∞–ª–∏–ª–∞—Å—è! (-20%!)", "warning"); triggerHaptic([50, 100, 50]); 
            } else if (marketMood > 0.12) {
                showToast("–ë–∏—á–∞—á–∏–π —Ç—Ä–µ–Ω–¥! –†–∏–Ω–∫–∏ —Ä–æ—Å—Ç—É—Ç—å.", "success");
            }
            
            const growthRate = (strat.rate / 12) + marketMood;
            state.investments = Math.max(0, state.investments + state.investments * growthRate); 
            
            state.netWorth = state.savings + state.investments;

            const rivalGrowth = state.rivalNetWorth * (0.04 / 12); 
            state.rivalNetWorth += (state.baseIncome * 1.2) * 0.2 + rivalGrowth;

            const nec = state.allocations.nec; const fun = state.allocations.fun;
            let hDecay = 0, fDecay = 0;
            if (nec < 40) hDecay = 12; else if (nec < 50) hDecay = 5; else state.health = Math.min(100, state.health + 3);
            if (fun < 10) fDecay = 10; else if (fun < 20) fDecay = 4; else state.happiness = Math.min(100, state.happiness + 3);
            
            if (state.inventory.includes('gym')) hDecay *= 0.5;
            if (state.inventory.includes('console')) fDecay *= 0.5;
            
            state.health = Math.max(0, state.health - hDecay);
            state.happiness = Math.max(0, state.happiness - fDecay);

            if (state.health < 30) { showToast("‚ö†Ô∏è –ó–¥–æ—Ä–æ–≤'—è –∫—Ä–∏—Ç–∏—á–Ω–æ –Ω–∏–∑—å–∫–µ!", "warning"); triggerHaptic([100, 50, 100]); }
            if (state.happiness < 30) { showToast("‚ö†Ô∏è –î–µ–ø—Ä–µ—Å—ñ—è –±–ª–∏–∑—å–∫–æ!", "warning"); triggerHaptic([100, 50, 100]); }

            // Shop Bouncing Logic
            const shopBtn = document.getElementById('shopBtn');
            if(shopBtn) {
                let canBuy = false;
                for(let item of SHOP_ITEMS) {
                    const owned = state.inventory.includes(item.id);
                    if(item.type === 'permanent' && owned) continue;
                    
                    const count = state.purchaseCounts[item.id] || 0;
                    const currentCost = item.type === 'consumable' ? Math.floor(item.cost * Math.pow(1.5, count)) : item.cost;
                    
                    if(state.savings >= currentCost) {
                        canBuy = true;
                        break;
                    }
                }
                
                if(canBuy) {
                    shopBtn.classList.add('shop-bounce', 'text-emerald-600', 'border-emerald-200');
                    shopBtn.classList.remove('text-indigo-600', 'border-indigo-100');
                } else {
                    shopBtn.classList.remove('shop-bounce', 'text-emerald-600', 'border-emerald-200');
                    shopBtn.classList.add('text-indigo-600', 'border-indigo-100');
                }
            }

            checkGameOver();
            state.month++;
            state.history.labels.push(state.month); state.history.savings.push(state.savings); state.history.investments.push(state.investments); state.history.rival.push(state.rivalNetWorth);
            updateUI(); updateChart();
        }

        function showDilemma(d) {
            const m = document.getElementById('eventModal');
            document.getElementById('eventTitle').innerText = d.title; document.getElementById('eventDesc').innerText = d.text;
            document.getElementById('eventIcon').className = `fa-solid ${d.icon}`;
            const c = document.getElementById('eventOptions'); c.innerHTML = '';
            d.options.forEach(opt => {
                const b = document.createElement('button');
                b.className = "w-full text-left p-3 rounded-lg border border-slate-200 hover:bg-indigo-50 hover:border-indigo-500 transition-all flex justify-between group";
                b.innerHTML = `<span class="font-bold text-sm">${opt.text}</span><i class="fa-solid fa-arrow-right text-slate-300 group-hover:text-indigo-500"></i>`;
                b.onclick = () => resolveDilemma(opt);
                c.appendChild(b);
            });
            m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10);
        }

        function resolveDilemma(opt) {
            if (opt.cost) {
                if (state.savings >= opt.cost) state.savings -= opt.cost;
                else {
                    const rem = opt.cost - state.savings; state.savings = 0;
                    if (state.investments >= rem) state.investments -= rem; else { state.investments=0; state.happiness-=20; }
                }
            }
            if (opt.health) state.health = Math.max(0, Math.min(100, state.health + opt.health));
            if (opt.happy) state.happiness = Math.max(0, Math.min(100, state.happiness + opt.happy));
            if (opt.xp) { state.careerXP += opt.xp; if(state.careerXP>=100) { state.careerXP-=100; state.incomeMultiplier+=0.1; } }
            if (opt.effect === 'risky_invest') { 
                if(Math.random()>0.5) { state.investments+=5000; showToast("–£—Å–ø—ñ—Ö! +$5000", "success"); triggerHaptic([50, 50]); } 
                else { showToast("–ü—Ä–æ–≤–∞–ª...", "warning"); triggerHaptic([100]); } 
            }
            
            state.netWorth = state.savings + state.investments;
            updateUI(); checkGameOver();
            const m = document.getElementById('eventModal'); m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300);
            saveGame();
        }

        function checkGameOver() { if (state.health <= 0 || state.happiness <= 0) { endGame(state.health <= 0 ? "–í–∏—Å–Ω–∞–∂–µ–Ω–Ω—è." : "–î–µ–ø—Ä–µ—Å—ñ—è."); localStorage.removeItem('finRaceSave'); } }
        function endGame(msg) { 
            document.getElementById('endDesc').innerText = msg; 
            document.getElementById('endGameModal').classList.remove('hidden'); 
            setTimeout(() => document.getElementById('endGameModal').classList.remove('opacity-0'), 100); 
            triggerHaptic([200, 100, 200]);
        }
        function showToast(msg, type='info') {
            const c = document.getElementById('toastContainer'); const el = document.createElement('div'); el.className = `toast toast-${type}`;
            const icon = type==='warning'?'<i class="fa-solid fa-triangle-exclamation"></i>':(type==='success'?'<i class="fa-solid fa-check"></i>':'<i class="fa-solid fa-info"></i>');
            el.innerHTML = `<div class="toast-icon">${icon}</div><div>${msg}</div>`; c.appendChild(el);
            requestAnimationFrame(()=>el.classList.add('show')); setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),300);},3000);
        }

        function setJarValue(id, newPct) {
            newPct = Math.max(0, Math.min(100, newPct)); // CLAMP ADDED HERE
            
            const old = state.allocations[id]; const diff = newPct - old;
            if(Math.abs(diff)<0.1) return;
            let pid = id==='sav'?'inv':'sav';
            
            if(state.allocations[pid]-diff < 0) {
               newPct = old + state.allocations[pid];
               state.allocations[pid]=0; 
            } else {
               state.allocations[pid]-=diff;
            }
            state.allocations[id] = newPct; 
            updateUI();
        }

        function updateUI() {
            const inc = (state.baseIncome * state.incomeMultiplier);
            document.getElementById('incomeDisplay').innerText = '$'+Math.floor(inc).toLocaleString();
            document.getElementById('incomeBoostDisplay').innerText = `+${Math.round((state.incomeMultiplier-1)*100)}%`;
            document.getElementById('xpBar').style.width = state.careerXP+'%'; document.getElementById('xpText').innerText = Math.floor(state.careerXP)+'/100';
            
            document.getElementById('hpBar').style.width = state.health+'%'; document.getElementById('happyBar').style.width = state.happiness+'%';
            const nec=state.allocations.nec, fun=state.allocations.fun;
            
            const hT=document.getElementById('healthTooltip'), haT=document.getElementById('happyTooltip');
            if(nec<40) { hT.innerText="–ö–†–ò–¢–ò–ß–ù–û! -12"; hT.className="tooltip bg-rose-600 font-bold"; } else if(nec<50) { hT.innerText="–ú–∞–ª–æ. -5"; hT.className="tooltip bg-amber-500"; } else { hT.innerText="–ù–æ—Ä–º–∞"; hT.className="tooltip bg-emerald-500"; }
            if(fun<10) { haT.innerText="–î–ï–ü–†–ï–°–Ü–Ø! -10"; haT.className="tooltip bg-rose-600 font-bold"; } else if(fun<20) { haT.innerText="–ù—É–¥–Ω–æ. -4"; haT.className="tooltip bg-amber-500"; } else { haT.innerText="–ù–æ—Ä–º–∞"; haT.className="tooltip bg-emerald-500"; }
            
            if(state.happiness<30) document.getElementById('jar-fun').classList.add('crit-pulse'); else document.getElementById('jar-fun').classList.remove('crit-pulse');
            if(state.health<30) document.getElementById('jar-nec').classList.add('crit-pulse'); else document.getElementById('jar-nec').classList.remove('crit-pulse');

            let hpPen = state.health<50?(state.health<20?0.5:0.8):1.0;
            JARS.forEach(j=>{
                document.getElementById(`liq-${j.id}`).style.height = state.allocations[j.id]+'%';
                document.getElementById(`pct-${j.id}`).innerText = Math.round(state.allocations[j.id])+'%';
                document.getElementById(`abs-${j.id}`).innerText = '$'+Math.floor((inc*hpPen)*(state.allocations[j.id]/100));
            });

            document.getElementById('netWorthDisplay').innerText = '$'+Math.floor(state.netWorth).toLocaleString();
            document.getElementById('rivalNetWorthDisplay').innerText = '$'+Math.floor(state.rivalNetWorth).toLocaleString();
            if(Math.random()>0.8) document.getElementById('rivalBubble').innerHTML = `<span class="font-bold not-italic text-rose-500">–î–∂–æ:</span> "${RIVAL_PHRASES[Math.floor(Math.random()*RIVAL_PHRASES.length)]}"`;

            const pas = (state.savings*0.04/12)+(state.investments*0.08/12);
            // Use strategy rate for display prediction, not random mood
            const predRate = STRATEGIES[state.activeStrategy].rate;
            const predPassive = (state.savings * 0.04 / 12) + (state.investments * predRate / 12);
            
            document.getElementById('passiveIncomeVal').innerText = '+$'+Math.floor(predPassive);
            
            const exp = (inc*hpPen)*((state.allocations.nec+state.allocations.fun)/100);
            document.getElementById('monthlyExpensesVal').innerText = '$'+Math.floor(exp);
            
            const target = exp*300;
            document.getElementById('freedomGoalVal').innerText = '$'+(target/1000).toFixed(0)+'k';
            const pct = Math.min(100,(state.netWorth/target)*100)||0;
            document.getElementById('freedomBar').style.width = pct+'%'; document.getElementById('freedomCurrentPct').innerText = pct.toFixed(1)+'%';
            const save = (inc*hpPen)-exp+predPassive;
            document.getElementById('freedomYearsText').innerText = (save<=0||pct>=100) ? (pct>=100?"–í–Ü–õ–¨–ù–ò–ô!":"–ù–µ–º–∞—î –Ω–∞–∫–æ–ø–∏—á–µ–Ω—å") : `~${((target-state.netWorth)/save/12).toFixed(1)} —Ä–æ–∫—ñ–≤`;

            document.getElementById('strategyName').innerText = STRATEGIES[state.activeStrategy].name;
            updateRoomVisuals();
        }

        function updateRoomVisuals() {
            const c=document.getElementById('roomObjects'), nw=state.netWorth;
            const l=document.getElementById('roomLabel');
            
            let i=['üì¶','üïØÔ∏è'];
            let t="–í–∏–∂–∏–≤–∞–Ω–Ω—è";
            
            if(nw>5000){i=['üõèÔ∏è','üçú']; t="–°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å";} 
            if(nw>25000){i=['üíª','üõãÔ∏è','üñºÔ∏è']; t="–°–µ—Ä–µ–¥–Ω—ñ–π –ö–ª–∞—Å";} 
            if(nw>100000){i=['üñ•Ô∏è','üêï','üõÅ']; t="–ó–∞–º–æ–∂–Ω—ñ—Å—Ç—å";} 
            if(nw>500000){i=['üèéÔ∏è','üíé','üå¥']; t="–ú—ñ–ª—å–π–æ–Ω–µ—Ä";}
            if(nw>1000000){i=['üöÄ','üè∞','üëë']; t="–û–ª—ñ–≥–∞—Ä—Ö";}

            if(!c.innerHTML || c.childElementCount !== i.length || c.firstChild.innerText !== i[0]) { 
                c.innerHTML=''; 
                i.forEach((ic,x)=>{const e=document.createElement('div');e.className='room-object animate-bounce';e.innerText=ic;e.style.left=(20+x*20)+'%';e.style.animationDelay=(x*0.2)+'s';c.appendChild(e);}); 
            }
            if(l) l.innerText = t;
        }

        function renderJars() {
            const c=document.getElementById('jarsContainer'); c.innerHTML='';
            JARS.forEach(j=>{
                const d=document.createElement('div'); d.className='flex flex-col items-center select-none';
                let th=''; if(j.id==='nec') th=`<div class="threshold-line" style="bottom:50%"><span class="threshold-label">HP Min</span></div>`;
                if(j.id==='fun') th=`<div class="threshold-line" style="bottom:20%"><span class="threshold-label">Happy Min</span></div>`;
                d.innerHTML=`<div class="jar-container w-full" id="jar-${j.id}" onmousedown="startDrag(event,'${j.id}')" ontouchstart="startDrag(event,'${j.id}')">${th}<div class="jar-liquid" id="liq-${j.id}" style="background-color:${j.liq};height:60%"><div class="jar-drag-handle"><i class="fa-solid fa-grip-lines"></i></div></div></div><div class="mt-1 text-center w-full"><div class="text-[10px] uppercase font-bold text-slate-500"><i class="fa-solid ${j.icon}" style="color:${j.color}"></i> ${j.name}</div><div class="text-xs font-bold" id="pct-${j.id}">0%</div><div class="text-[9px] text-slate-400" id="abs-${j.id}">$0</div></div>`;
                c.appendChild(d);
            });
        }
        function startDrag(e,id){isDragging=true;activeJarId=id;document.body.style.overflow='hidden'; triggerHaptic(10); }
        function endDrag(){isDragging=false;activeJarId=null;document.body.style.overflow='';}
        function onDrag(e){if(!isDragging||!activeJarId)return;e.preventDefault();const el=document.getElementById(`jar-${activeJarId}`),r=el.getBoundingClientRect(),y=e.touches?e.touches[0].clientY:e.clientY;setJarValue(activeJarId,100-((y-r.top)/r.height*100));}

        function initChart() {
            const ctx=document.getElementById('mainChart').getContext('2d');
            chartInstance=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'–°–µ–π—Ñ',data:[],borderColor:'#10B981',backgroundColor:'rgba(16,185,129,0.4)',fill:'origin',tension:0.3,stack:'p',pointRadius:0},{label:'–†–∏–∑–∏–∫',data:[],borderColor:'#6366F1',backgroundColor:'rgba(99,102,241,0.4)',fill:'-1',tension:0.3,stack:'p',pointRadius:0},{label:'–î–∂–æ',data:[],borderColor:'#F43F5E',backgroundColor:'transparent',borderDash:[5,5],fill:false,tension:0.3,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>(c.dataset.label||'')+': '+(c.parsed.y!==null?'$'+Math.floor(c.parsed.y).toLocaleString():'')}}},scales:{y:{beginAtZero:true,stacked:true,grid:{display:false}},x:{display:false}}}});
        }
        function updateChart(){chartInstance.data.labels=state.history.labels;chartInstance.data.datasets[0].data=state.history.savings;chartInstance.data.datasets[1].data=state.history.investments;chartInstance.data.datasets[2].data=state.history.rival;chartInstance.update();}
        function triggerConfetti(){confetti({particleCount:100,spread:70,origin:{y:0.6}});}
        function endGame(msg) { document.getElementById('endDesc').innerText = msg; document.getElementById('endGameModal').classList.remove('hidden'); setTimeout(() => document.getElementById('endGameModal').classList.remove('opacity-0'), 100); }
        init();
    </script>
</body>
</html>
